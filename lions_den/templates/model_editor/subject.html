{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}
	<form enctype="multipart/form-data" method="POST">
		{% csrf_token %}
		{{ attributes_formset.management_form }}
		
		{{ subject_form.name|as_crispy_field }}
		
		{% if subject.species %}
			<table>
				<tr>
					<td><legend>Species:</legend></td>
					<td><h1 class="mx-2">{{ subject.species.name }}</h1></td>
				</tr>
			</table>
		{% endif %}
		
		<hr>
		
		<legend>{{ subject_form.image.label }}</legend>
		<img id="id_subject_image_display" style="max-height:200px" src="data:image/png;base64,{{ subject.image_str }}"/>
		<br/><br/>
		{{ subject_form.image }}
		
		<hr>
		
		{% if 'audio' in subject_form.fields %}
			<legend>{{ subject_form.audio.label }}</legend>
			<audio id="id_audio_control" controls><source id="id_subject_audio_display" src="data:audio/mp3;base64,{{ subject.audio_str }}"/></audio>
			<br/><br/>
			{{ subject_form.audio }}
			{% if subject.audio %}
				<input type="checkbox" id="DELETE-FIELD_audio" name="DELETE-FIELD_audio">
				<label for="DELETE-FIELD_audio" class="form-check-label">Delete</label>
			{% endif %}
			<hr>
		{% endif %}
		
		{% if 'gender' in subject_form.fields %}
			{{ subject_form.gender|as_crispy_field }}
			<hr>
		{% endif %}
		
		{% if 'dob' in subject_form.fields %}
			{{ subject_form.dob|as_crispy_field }}
			<hr>
		{% endif %}
		
		{% if 'place_of_birth' in subject_form.fields %}
			{{ subject_form.place_of_birth|as_crispy_field }}
			<hr>
		{% endif %}
		
		{% if 'weight' in subject_form.fields %}
			{{ subject_form.weight|as_crispy_field }}
			<hr>
		{% endif %}
		
		{% if 'size' in subject_form.fields %}
			{{ subject_form.size|as_crispy_field }}
			<hr>
		{% endif %}
		
		<br/>
		<legend>Attributes</legend>
		{% if new_attribute_form %}
			<button class="button outline btn-lg" type="button" data-toggle="modal" data-target="#modalForm">Add new attribute</button>
			<br/>
		{% endif %}
		<br/>
			<table>
				{{ attributes_formset|crispy }}
			</table>
		<button class="button outline btn-lg" name="submit" type="submit">Submit</button>
	</form>
	{% if new_attribute_form %}
		{% include 'model_editor/modal_form.html' with form=new_attribute_form submit_btn_name='add_new_attribute' title='New Attribute' %}
	{% endif %}
{% endblock content %}

{% block script %}
	function setDynamicBlobDisplay(displayID, widgetID, audioControlID) {
		let reloadAudio = function(){ if (audioControlID){ $("#" + audioControlID)[0].load() } };
		var initialValue = document.getElementById(displayID).src;
		document.querySelector('#' + widgetID).addEventListener('change', function() {
			var file = document.getElementById(widgetID).files[0];
			var displayElement = document.getElementById(displayID);
			if (file){
				var reader  = new FileReader();
				reader.onload = function(e) {
					displayElement.src = e.target.result;
					reloadAudio();
				};
				reader.readAsDataURL(file);
			} else {
				displayElement.src = initialValue;
				reloadAudio();
			}
		});
	};
	setDynamicBlobDisplay("id_subject_image_display", "id_subject-image");
	setDynamicBlobDisplay("id_subject_audio_display", "id_subject-audio", "id_audio_control");
{% endblock script %}