{% extends 'ticket_system/base.html' %}
{% load lions_den_tags %}
{% load crispy_forms_tags %}

{% block content %}
	<div class="row shadow-lg">
		<div class="col-9 border">
			<div class="my-2">
				<div class="float-left"><h2>{{ object }}</h2></div>
				<div class="float-right">
					<div class="row">
						<div class="col px-0 mx-1">
							{% if request.user == object.reporter or request.user.is_staff %}
								<div id="EditTicketDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									{% include 'utils/buttons/edit.html' with css_class='edit-ticket-button' height=20 width=20 tooltip_text='Edit ticket' tooltip_placement='top' %}
								</div>
								<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
									<a class="dropdown-item" href="#" onclick="getModal('modal_edit_ticket')">Edit Ticket</a>
									<a class="dropdown-item" href="#" onclick="getModal('modal_ticket_status')">Edit Status</a>
								</div>
							{% endif %}
						</div>
						<div class="col px-0 mx-3">
							{% if user_is_watcher %}
								{% include 'utils/buttons/eye.html' with stroke='var(--colorPrimary)' height=20 width=20 tooltip_text='Stop watching' tooltip_placement='top' onclick='setUserWatcherStatus(false)' id='add_as_watcher_btn' %}
							{% else %}
								{% include 'utils/buttons/eye.html' with stroke='var(--colorForeground)' height=20 width=20 tooltip_text='Start watching' tooltip_placement='top' onclick='setUserWatcherStatus(true)' id='add_as_watcher_btn' %}
							{% endif %}
						</div>
					</div>
				</div>
				<div class="clearfix"></div>
				
				<h6 style="color:var(--colorPrimaryDark)">{{ object.get_app_display }}</h6>
			</div>
			<div class="row mt-3 text-center">
				<div class="col-4 center">
					<p><b>Type:</b> {{ object.get_type_display }}</p>
				</div>
				<div class="col-4 center">
					<p><b>Priority:</b> {{ object.get_priority_display }}</p>
				</div>
				<div class="col-4 center">
					<p><b>Status:</b> <span style="color: {{ object.get_status_colour }}">{{ object.get_status_display}}</span></p>
				</div>
			</div>
			<div class="mx-2 mb-4 mt-2">
				<p style="white-space:pre-wrap">{{ object.description }}</p>
			</div>
		</div>
		
		<div class="col-3 border container-fluid small">
			<div class="row border-bottom my-3">
				<div class="container">
					<div class="float-left"><p><b>Created by:</b></p></div>
					<div class="float-right"><p>{{ object.reporter }}</p></div>
					<div class="clearfix"></div>
					
					<div class="float-left"><p><b>Last updated by:</b></p></div>
					<div class="float-right"><p>{{ object.last_updater }}</p></div>
					<div class="clearfix"></div>
					
					<div class="float-left"><p><b>{% if object.assignee %}Assigned to:{% else %}Unassigned{% endif %}</b></p></div>
					<div class="float-right">
						{% if object.assignee %}<p>{{ object.assignee }}{% endif %}
						{% if request.user.is_staff %}
							{% include 'utils/buttons/edit.html' with css_class='edit-ticket-button' height=16 width=16 onclick="getModal('modal_assign_ticket')" tooltip_text='Assign ticket' %}
						{% endif %}
						{% if object.assignee %}</p>{% endif %}
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
			<div class="row my-3">
				<div class="container">
					<div class="float-left"><p><b>Created on:</b></p></div>
					<div class="float-right"><p>{{ object.created_date }}</p></div>
					<div class="clearfix"></div>
					
					<div class="float-left"><p><b>Last updated on:</b></p></div>
					<div class="float-right"><p>{{ object.last_updated_date }}</p></div>
					<div class="clearfix"></div>
					
					{% if object.closed_date %}
						<div class="float-left"><p><b>Closed on:</b></p></div>
						<div class="float-right"><p>{{ object.closed_date }}</p></div>
						<div class="clearfix"></div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
	<div class="mt-4">
		<h4 style="color:var(--colorPrimaryDark)">Attachments</h4>
		<div class="container">
			{% if object.attachments.count %}
				<table class="table table-bordered" style="max-width:30%">
					<tr class="">
						<th>File</th>
						<th>Date uploaded</th>
					</tr>
					{% for attachment in object.attachments.all %}
						<tr>
							<td><a href="{{ attachment.file.url }}" target="_blank">{{ attachment }}</a></td>
							<td>{{ attachment.uploaded_date }}</td>
						</tr>
					{% endfor %}
				</table>
			{% endif %}
			<button class="btn btn-primary" onclick="getModal('modal_new_attachment')">Add attachment</button>
		</div>
	</div>
	
	<div class="mt-4">
		<h4 style="color:var(--colorPrimaryDark)">Comments</h4>
		{% if object.comments.all %}
			<div class="small">
				{% for comment in object.comments.all %}
					<div class="comment shadow mb-2">
						<div class="comment-header">
							<div class="float-left"><b>{{ comment.creator }}</b> commented on {{ comment.added_date }}</div>
							<div class="float-right">
								{% if request.user == comment.creator %}
									{% include 'utils/buttons/edit.html' with css_class='edit-ticket-button' height=14 width=14 onclick="getModal('modal_edit_comment', 'id="|addstr:comment.id|addstr:"')" %}
								{% endif %}
							</div>
							<div class="clearfix"></div>
						</div>
						<div class="comment-body pt-2 pb-1">
							<p style="white-space:pre-wrap">{{ comment.text }}</p>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}
	</div>
	
	<div class="container">
		<form method="POST" class="mt-4">
			{% csrf_token %}
			{{ comment_form|crispy }}
			<button type="submit" class="btn btn-primary" name="{{ comment_form_submit_btn_name }}">Add comment</button>
		</form>
	</div>
{% endblock %}